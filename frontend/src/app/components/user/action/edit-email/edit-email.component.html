<main class="page min-h-[60vh]">
  <section aria-labelledby="email-change-title" class="card max-w-md w-full text-center">
    <h1 id="email-change-title" class="section-title">Changer d’adresse e-mail</h1>

    <!-- Formulaire principal -->
    <form (ngSubmit)="openConfirmModal()" #emailForm="ngForm" class="space-y-5">
      <div class="text-left">
        <label for="email" class="label">Nouvelle adresse e-mail</label>
        <input
          type="email"
          id="email"
          name="email"
          [(ngModel)]="newEmail"
          (ngModelChange)="checkEmailAvailability()"
          required
          placeholder="nouvel.email@exemple.com"
          class="input mt-1"
        />

        <!-- Validation dynamique -->
        <div *ngIf="newEmail" class="mt-2 text-sm">
          <span *ngIf="checking" class="text-neutral-400 italic">Vérification en cours...</span>
          <span *ngIf="!checking && emailTaken" class="text-red-500 font-medium">
            Cette adresse e-mail est déjà utilisée.
          </span>
          <span *ngIf="!checking && !emailTaken" class="text-green-500 font-medium">
            Cette adresse e-mail est disponible.
          </span>
        </div>
      </div>

      <button
        type="submit"
        [disabled]="emailForm.invalid || emailTaken || checking"
        class="btn-primary w-full py-2.5 font-bold"
      >
        Modifier l’adresse e-mail
      </button>

      <nav aria-label="Retour au profil" class="mt-3 text-center">
        <a routerLink="/profil" class="btn-text">← Retour au profil</a>
      </nav>
    </form>
  </section>

  <!-- === Modale de confirmation === -->
  <div *ngIf="showConfirmModal" class="modal-overlay">
    <div class="modal">
      <h2 class="modal-title">Confirmer le changement</h2>
      <p class="modal-text">
        Pour valider la modification de ton adresse e-mail, entre ton mot de passe :
      </p>

      <input
        type="password"
        [(ngModel)]="confirmPassword"
        name="confirmPassword"
        placeholder="••••••••"
        class="input mb-3"
      />

      <p *ngIf="error" class="alert-error mb-4 text-center">{{ error }}</p>

      <div class="flex justify-between">
        <button type="button" (click)="closeConfirmModal()" class="btn-outline p-2">
          Annuler
        </button>
        <button
          (click)="confirmEmailChange()"
          [disabled]="!confirmPassword"
          class="btn-primary p-2"
        >
          Confirmer
        </button>
      </div>
    </div>
  </div>

  <!-- === Modale de succès === -->
  <div *ngIf="showSuccessModal" class="modal-overlay">
    <div class="modal animate-fadeIn text-center">
      <div class="flex justify-center mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-14 h-14 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
      </div>

      <h2 class="modal-title">Changement réussi !</h2>
      <p class="modal-text mb-6">
        Ton adresse e-mail a été mise à jour avec succès.<br />
        Tu peux désormais te reconnecter avec ton nouveau compte.
      </p>

      <button (click)="closeSuccessModal()" class="btn-primary w-full py-2.5">
        Fermer
      </button>
    </div>
  </div>
</main>
